// Sanitize function
function sanitize(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

// Fetch CSV with error handling
async function fetchCSV(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.text();
        const parsedData = Papa.parse(data, { header: true });
        if (parsedData.errors.length) throw new Error('Parsing error');
        return parsedData.data;
    } catch (error) {
        console.error('Error fetching or parsing data:', error);
        alert('There was an error loading the data.');
        return [];
    }
}

let chart; // Declare chart variable globally to update it later if needed

// Load summary with sanitized data and explicit columns
async function loadSummary() {
    const summaryData = await fetchCSV('summary.csv');
    const summaryBody = document.getElementById('summary-body');
    const columns = ['Date', 'Rounds of Play', 'Hit % Baseline', '1st Serve %', '2nd Serve %', 'Service Games Played', 'Duration in min', 'Comment'];

    summaryData.forEach(row => {
        const tr = document.createElement('tr');
        tr.setAttribute('tabindex', '0');

        columns.forEach(col => {
            const td = document.createElement('td');
            td.innerHTML = sanitize(row[col]);
            tr.appendChild(td);
        });

        tr.addEventListener('click', () => {
            document.querySelectorAll('#summary-table tr').forEach(row => row.classList.remove('selected'));
            tr.classList.add('selected');
            loadDetails(row['Date']);
            updateChart(row['Date']); // Update chart for selected date
        });

        tr.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                tr.click();
            }
        });

        summaryBody.appendChild(tr);
    });
}

// Load details with sanitized data and explicit columns
async function loadDetails(date) {
    const roundsData = await fetchCSV('rounds.csv');
    const detailsBody = document.getElementById('details-body');
    const detailsTable = document.getElementById('details-table');
    const columns = ['Round #', 'Hit % Baseline', '1st Serve %', '2nd Serve %', 'Service Games Played'];
    detailsBody.innerHTML = '';

    const dateToMatch = date.trim();

    roundsData
        .filter(row => row['Date'].trim() === dateToMatch)
        .forEach(row => {
            const tr = document.createElement('tr');
            columns.forEach(col => {
                const td = document.createElement('td');
                td.innerHTML = sanitize(row[col]);
                tr.appendChild(td);
            });
            detailsBody.appendChild(tr);
        });

    detailsTable.style.display = 'table';
}

// Prepare data for the chart
async function prepareChartData() {
    const summaryData = await fetchCSV('summary.csv');
    const labels = [];
    const hitBaselineData = [];
    const firstServeData = [];
    const secondServeData = [];

    summaryData.forEach(row => {
        labels.push(row['Date'].trim());
        hitBaselineData.push(parseFloat(row['Hit % Baseline']));
        firstServeData.push(parseFloat(row['1st Serve %']));
        secondServeData.push(parseFloat(row['2nd Serve %']));
    });

    createChart(labels, hitBaselineData, firstServeData, secondServeData);
}

// Create the chart
function createChart(labels, hitBaselineData, firstServeData, secondServeData) {
    const ctx = document.getElementById('performanceChart').getContext('2d');

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Hit % Baseline',
                    data: hitBaselineData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    fill: false,
                    tension: 0.1
                },
                {
                    label: '1st Serve %',
                    data: firstServeData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    fill: false,
                    tension: 0.1
                },
                {
                    label: '2nd Serve %',
                    data: secondServeData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            }
        }
    });
}

// Update chart with details data
async function updateChart(date) {
    const roundsData = await fetchCSV('rounds.csv');
    const filteredData = roundsData.filter(row => row['Date'].trim() === date.trim());

    const labels = [];
    const hitBaselineData = [];
    const firstServeData = [];
    const secondServeData = [];

    filteredData.forEach(row => {
        labels.push('Round ' + row['Round #']);
        hitBaselineData.push(parseFloat(row['Hit % Baseline']));
        firstServeData.push(parseFloat(row['1st Serve %']));
        secondServeData.push(parseFloat(row['2nd Serve %']));
    });

    // Update chart data
    chart.data.labels = labels;
    chart.data.datasets[0].data = hitBaselineData;
    chart.data.datasets[1].data = firstServeData;
    chart.data.datasets[2].data = secondServeData;
    chart.update();
}

// Initial load
window.onload = function() {
    loadSummary();
    prepareChartData();
};
